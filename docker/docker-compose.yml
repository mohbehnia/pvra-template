version: '3.9'


services:
  aesm:
    image: sgx_aesm #TODO build
    devices:
      - /dev/sgx/enclave
      - /dev/sgx/provision
    volumes:
      - aesmd-socket:/var/run/aesmd
    stdin_open: true
    tty: true
    environment:
      - http_proxy
      - https_proxy
#      - LD_LIBRARY_PATH=/opt/intel/sgxpsw/aesm
#  aesm:
#    image: initc3/linux-sgx:2.13-ubuntu20.04
#    devices:
#      - /dev/isgx
#    volumes:
#      - aesmd-socket:/var/run/aesmd
#      #- ./aesmd.conf:/etc/aesmd.conf
#    user: aesmd
#    #stdin_open: true
#    #tty: true
#    working_dir: /opt/intel/sgx-aesm-service/aesm
#    environment:
#      LD_LIBRARY_PATH: /opt/intel/sgx-aesm-service/aesm
#    command: ./aesm_service --no-daemon

  billboard:
    image: trufflesuite/ganache-cli:v6.12.2
    ports:
      - 8545:8545
    volumes:
      - accounts:/accounts/
    command: ["--deterministic", "nerla","--gasLimit","0x6691b70", "--accounts", "10", "--account_keys_path", "/accounts/accounts.json", "--debug"]

  enclave:
    image: ${APP_NAME}-enclave
    build:
      context: ../
      dockerfile: docker/Dockerfile
      args:
        SGX_MODE: HW
        SGX_DEBUG: 1
        APP_NAME: ${APP_NAME}
    working_dir: /home/photon/${APP_NAME}/scripts/
    environment:
      CCF_ENABLE: ${CCF_ENABLE}
      SGX_SPID: ${SGX_SPID}
      IAS_PRIMARY_KEY: ${IAS_PRIMARY_KEY}
      PYTHONBREAKPOINT: ipdb.set_trace
      SGX_DEBUG: 1
      NUM_USERS: ${NUM_USERS}
      PROJECT_ROOT: /home/photon/${APP_NAME}
      http_proxy: ${http_proxy}
      https_proxy: ${https_proxy}
    devices:
      - /dev/sgx/enclave
    volumes:
      - aesmd-socket:/var/run/aesmd
      - accounts:/home/photon/${APP_NAME}/accounts/
      - ../billboard/solidity:/home/photon/${APP_NAME}/solidity/
      - ../enclave:/home/photon/${APP_NAME}/enclave/
      - ../app:/home/photon/${APP_NAME}/app/
      - ../scripts:/home/photon/${APP_NAME}/scripts/
      - ../applications/${APP_NAME}:/home/photon/${APP_NAME}/src
    stdin_open: true
    tty: true
    depends_on:
      - billboard
      - aesm
    command: python demo.py

volumes:
  accounts:
  aesmd-socket:
    driver: local
    driver_opts:
      type: "tmpfs"
      device: "tmpfs"
      o: "rw"
